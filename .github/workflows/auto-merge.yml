# Risk-Based Auto Merge (LOW risk ONLY)
#
# SAFETY PRINCIPLES (Non-Negotiable):
# - NO auto-merge for Medium / High / Critical
# - NO auto-merge if AI is uncertain
# - NO auto-merge without green CI
# - ONLY applies to: formatting, lint, docs, comments
# - Fully auditable via labels and PR comments

name: Risk-Based Auto Merge

on:
  pull_request:
    types: [labeled, synchronize]

permissions:
  contents: write
  pull-requests: write

jobs:
  auto-merge:
    name: "ðŸ¤– Auto-Merge (LOW risk only)"
    runs-on: ubuntu-latest
    # Only run if risk:LOW label is present
    if: contains(github.event.pull_request.labels.*.name, 'risk:LOW')

    steps:
      - name: Verify CI Status
        id: ci-check
        run: |
          # Get CI status for the PR
          STATUS=$(gh pr checks ${{ github.event.pull_request.number }} --json state --jq '.[].state' | sort -u)

          if echo "$STATUS" | grep -q "FAILURE"; then
            echo "CI has failures. Cannot auto-merge."
            echo "can_merge=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          if echo "$STATUS" | grep -q "PENDING"; then
            echo "CI still running. Will wait for completion."
            echo "can_merge=pending" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "All CI checks passed."
          echo "can_merge=true" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Enable Auto-Merge
        if: steps.ci-check.outputs.can_merge == 'true'
        run: |
          echo "Enabling auto-merge for LOW risk PR..."

          gh pr merge ${{ github.event.pull_request.number }} \
            --auto \
            --squash \
            --delete-branch

          echo "Auto-merge enabled. PR will merge when all checks pass."
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Add Auto-Merge Comment
        if: steps.ci-check.outputs.can_merge == 'true'
        run: |
          gh pr comment ${{ github.event.pull_request.number }} --body "### Auto-Merge Enabled

          This PR has been classified as **LOW risk** by the AI auditor.

          **What this means:**
          - Changes are cosmetic (formatting, lint, docs, comments)
          - No business logic impact
          - No security impact
          - All CI checks must still pass

          **Auto-merge will proceed when:**
          - All required status checks pass
          - No blocking reviews exist

          ---
          > To disable auto-merge, remove the \`risk:LOW\` label."
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Skip - CI Not Ready
        if: steps.ci-check.outputs.can_merge != 'true'
        run: |
          echo "Auto-merge not enabled: CI checks not ready or failing."
          echo "Status: ${{ steps.ci-check.outputs.can_merge }}"
